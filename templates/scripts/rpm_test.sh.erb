#!/bin/bash

set -ex

project=<%= @product.dump %>
os=<%= @_os.dump %>
dist=<%= @_dist.dump %>

# from job environment
: ${arch:=x86_64}

repo="$WORKSPACE"/archive/rpmbuild/RPMS

if [ "$arch" = x86 ]; then
  target_arch=i386
else
  target_arch="$arch"
fi

# Preparing local repository
case "$os" in
  centos|fedora)
    sudo setarch "$target_arch" yum install -y createrepo
    createrepo "$repo"

    sudo -E su -c "cat << EOF > /etc/yum.repos.d/local.repo
[local]
name=local workspace
baseurl=file://$repo
enabled=1
gpgcheck=0
EOF"
    ;;
  sles|opensuse)
    # Just use the local dir, zypper will take care of the rest!
    sudo setarch "$target_arch" zypper addrepo --no-gpgcheck "$repo" local
    ;;
  *)
    echo "OS $os not supported in testing..." >&2
    exit 1
    ;;
esac

if [ ! -f archive/"${project}"-package.version ]; then
  echo "archive/${project}-package.version artifact is required!" >&2
  exit 1
fi
package_version=$(cat archive/"${project}"-package.version | tr -d '\r\n')

# Helper to install packages
install_package() {
  versioned=1
  if [ "$1" = "-n" ] || [ "$1" = "--no-version" ]; then
    shift
    versioned=0
  fi

  packages=()
  for package in "$@"
  do
    packages+=("${package}-${package_version}")
  done

  case "$os" in
    centos|fedora)
      sudo setarch "$target_arch" yum install -y "${packages[@]}"
      ;;
    sles|opensuse)
      sudo setarch "$target_arch" zypper install -y "${packages[@]}"
      ;;
    *)
      echo "OS $os not supported in testing - package install..." >&2
      exit 1
      ;;
  esac
}

source ./packaging/"$project"/testing/start_test.sh
