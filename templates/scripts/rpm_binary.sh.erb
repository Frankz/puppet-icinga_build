#!/bin/bash

set -ex

# configuration
project=<%= @product.dump %>
os=<%= @_os.dump %>
dist=<%= @_dist.dump %>

# from job environment
: ${arch:=x86_64}

###
# please do not edit below
###

: ${BUILD_VERSION:=1}
: ${WORKDIR:=`pwd`}

if [ "$arch" = x86 ]; then
  target_arch=i386
else
  target_arch="$arch"
fi

<%= scope.function_template(['icinga_build/scripts/rpm_functions.sh.erb']) %>

# enabling ccache
export CCACHE_DIR="$WORKSPACE/ccache"

# repair/prepare ccache (needed on some distros like CentOS 5 + 6, SUSE, OpenSUSE)
CCACHE_LINKS=`setarch "$target_arch" rpm -E %_libdir`/ccache
sudo sh -ex <<CCACHEREPAIR
  test -d ${CCACHE_LINKS} || mkdir ${CCACHE_LINKS}
  cd ${CCACHE_LINKS}
  echo 'Preparing/Repairing ccache symlinks...'
  for comp in cc cpp c++ gcc g++; do
    [ ! -e \${comp} ] || continue
    ln -svf /usr/bin/ccache \${comp}
  done
CCACHEREPAIR

source_rpm="$(ls rpmbuild/SRPMS/*.src.rpm)"

if [ $(echo "${source_rpm}" | wc -l) -gt 1 ]; then
  echo "More than one spec file found:" >&2
  ls -al rpmbuild/SRPMS >&2
  exit 1
fi

# TODO: Workaround for rpmdb corruption
# https://github.com/hengeldev/docker-ci-containers/commit/5d305376df72ca595e11f412e3b3827c3859e113
#sudo rpm --rebuilddb

# Installing dependencies
case "$os" in
  opensuse|sles)
    sudo setarch "$target_arch" zypper --non-interactive install `rpm -qpR "${source_rpm}"`
    ;;
  *)
    sudo setarch "$target_arch" yum clean expire-cache
    sudo setarch "$target_arch" yum-builddep -y "${source_rpm}"
    ;;
esac

if [ -e /opt/rh/devtoolset-2/enable ]; then
  echo "Patching devtoolset-2 to use ccache..."
  # This is the only good way to re-add ccache to top of PATH
  # scl enable (inside icinga2.spec) will set its own path first
  sudo sh -ex <<SUDOSCRIPT
    echo 'PATH="${CCACHE_LINKS}:\${PATH}" to /opt/rh/devtoolset-2/enable'
    echo 'PATH="${CCACHE_LINKS}:\${PATH}"' >> /opt/rh/devtoolset-2/enable
SUDOSCRIPT
else
  # Enable ccache as a default wrapper for compilers
  PATH="${CCACHE_LINKS}:${PATH}"
fi

# build the actual packages
eval "$(get_rpmbuild --rebuild "${source_rpm}")"

if [ -e /opt/rh/devtoolset-2 ]; then
  # Run in a newer compiler environment
  # Environment needs to be set here for ccache to find the compiler to use...
  scl enable devtoolset-2 -- "${RPMBUILD[@]}"
else
  "${RPMBUILD[@]}"
fi
